<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>台股市場成交值比重</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background-color: #1a1a1a; color: white; overflow: hidden; font-family: "Microsoft JhengHei", sans-serif; }
        #header { 
            height: 75px; display: flex; align-items: center; justify-content: space-between; 
            padding: 0 20px; background: #222; border-bottom: 1px solid #444; 
        }
        .title-group { display: flex; flex-direction: column; }
        #date-display { font-size: 1.1rem; font-weight: bold; color: #ffca28; }
        #total-volume { font-size: 0.9rem; color: #00e5ff; margin-top: 2px; }
        
        #date-selector { 
            padding: 8px 15px; background: #333; color: white; border: 1px solid #666; 
            border-radius: 4px; cursor: pointer; font-size: 14px; outline: none;
        }
        #date-selector:hover { border-color: #ffca28; }
        
        #main { width: 100vw; height: calc(100vh - 75px); }
        #loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 18px; z-index: 10; background: rgba(0,0,0,0.8); padding: 20px; border-radius: 8px; border: 1px solid #444; }
    </style>
</head>
<body>
    <div id="header">
        <div class="title-group">
            <div id="date-display">正在初始化...</div>
            <div id="total-volume">計算中...</div>
        </div>
        <div>
            <select id="date-selector">
                <option value="latest.json">最新資料</option>
            </select>
        </div>
    </div>
    
    <div id="loading">資料載入中...</div>
    <div id="main"></div>

    <script>
        const chartDom = document.getElementById('main');
        const myChart = echarts.init(chartDom, 'dark');
        const dateDisplay = document.getElementById('date-display');
        const totalVolumeDisplay = document.getElementById('total-volume');
        const loadingEl = document.getElementById('loading');
        const dateSelector = document.getElementById('date-selector');

        const BASE_URL = './data/STOCK_DAY_ALL/';
        let currentTotalTradeValue = 0; // 全域變數儲存當日總成交額

        function formatDisplayDate(str) {
            if (!str) return '';
            const clean = str.replace('.json', '');
            if (clean === 'latest') return '最新資料';
            if (clean.includes('-')) {
                const parts = clean.split('-');
                return `${parseInt(parts[0]) - 1911}/${parts[1]}/${parts[2]}`;
            }
            if (clean.length >= 7) {
                return `${clean.substring(0, 3)}/${clean.substring(3, 5)}/${clean.substring(5, 7)}`;
            }
            return clean;
        }

        async function updateChart(fileName) {
            loadingEl.style.display = 'block';
            try {
                const response = await fetch(`${BASE_URL}${fileName}?v=${new Date().getTime()}`);
                if (!response.ok) throw new Error('檔案讀取失敗');
                const rawData = await response.json();

                // 1. 計算總成交額 (TradeValue)
                currentTotalTradeValue = rawData.reduce((acc, cur) => acc + (parseFloat(cur.TradeValue) || 0), 0);
                
                // 更新上方顯示 (轉為億元)
                const totalInBillion = (currentTotalTradeValue / 100000000).toLocaleString(undefined, {maximumFractionDigits: 2});
                totalVolumeDisplay.innerText = `市場總成交值：約 ${totalInBillion} 億元`;

                if (rawData.length > 0) {
                    dateDisplay.innerText = `資料日期：${formatDisplayDate(rawData[0].Date)}`;
                }

                // 2. 處理資料
                const chartData = rawData
                    .filter(item => parseFloat(item.TradeValue) > 0)
                    .map(item => {
                        const val = parseFloat(item.TradeValue);
                        const change = parseFloat(item.Change) || 0;
                        const ratio = ((val / currentTotalTradeValue) * 100).toFixed(2); // 計算個股佔比
                        
                        let color = '#999';
                        if (change > 0) color = '#ef5350';
                        else if (change < 0) color = '#26a69a';

                        return {
                            name: `${item.Name}\n${ratio}%`, // 方塊上直接顯示百分比
                            value: val,
                            itemStyle: { color: color },
                            raw: { ...item, ratio: ratio } // 將佔比存入 raw 供 Tooltip 使用
                        };
                    });

                myChart.setOption({
                    tooltip: {
                        trigger: 'item',
                        formatter: function (info) {
                            const d = info.data.raw;
                            return `
                                <div style="font-weight:bold; border-bottom:1px solid #666; margin-bottom:5px; padding-bottom:5px;">${d.Name} (${d.Code})</div>
                                成交價：${d.ClosingPrice || d.Close}<br/>
                                漲跌幅：<span style="color:${parseFloat(d.Change) >= 0 ? '#ff4d4f' : '#52c41a'}">${d.Change}%</span><br/>
                                成交金額：${(parseFloat(d.TradeValue) / 100000000).toFixed(2)} 億<br/>
                                <div style="color:#ffca28; margin-top:5px; font-weight:bold;">成交量佔比：${d.ratio}%</div>
                            `;
                        }
                    },
                    series: [{
                        type: 'treemap',
                        data: chartData,
                        roam: false,
                        nodeClick: false,
                        breadcrumb: { show: false },
                        label: { 
                            show: true, 
                            position: 'inside', 
                            formatter: '{b}', 
                            fontSize: 12,
                            lineHeight: 16
                        },
                        itemStyle: { borderColor: '#1a1a1a', borderWidth: 1, gapWidth: 1 }
                    }]
                }, true);

                loadingEl.style.display = 'none';
            } catch (err) {
                loadingEl.innerText = '錯誤: ' + err.message;
            }
        }

        async function init() {
            try {
                const listRes = await fetch(`${BASE_URL}filelist.json?v=${new Date().getTime()}`);
                if (listRes.ok) {
                    const files = await listRes.json();
                    dateSelector.innerHTML = '';
                    files.forEach(file => {
                        const opt = document.createElement('option');
                        opt.value = file;
                        opt.text = formatDisplayDate(file);
                        dateSelector.appendChild(opt);
                    });
                }
            } catch (e) {
                console.warn("無法取得 filelist.json");
            }
            updateChart(dateSelector.value);
        }

        dateSelector.addEventListener('change', (e) => updateChart(e.target.value));
        window.addEventListener('resize', () => myChart.resize());
        init();
    </script>
</body>
</html>
