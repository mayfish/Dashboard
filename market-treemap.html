<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>台股市場成交值比重 - Treemap</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; }
        /* 必須給容器明確的高度 */
        #main { width: 100vw; height: 100vh; }
        #loading {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-family: sans-serif; font-size: 20px; color: #666;
        }
    </style>
</head>
<body>
    <div id="loading">資料讀取中...</div>
    <div id="main"></div>

    <script>
        const chartDom = document.getElementById('main');
        const myChart = echarts.init(chartDom);
        const loadingEl = document.getElementById('loading');

        // 格式化資料：將扁平陣列轉為 ECharts 樹狀結構
        function formatData(rawData) {
            // 我們以「產業別」作為分類基準
            const categories = {};
            
            rawData.forEach(item => {
                const cat = item.Industry || '其他';
                if (!categories[cat]) {
                    categories[cat] = { name: cat, children: [] };
                }
                
                // 計算漲跌顏色
                const change = parseFloat(item.Change);
                const color = change > 0 ? '#ff4d4f' : (change < 0 ? '#52c41a' : '#bfbfbf');

                categories[cat].children.push({
                    name: `${item.Name}\n${item.Code}`,
                    value: parseFloat(item.TradeValue) || 0, // 以成交值決定方塊大小
                    itemStyle: { color: color },
                    // 自定義標籤內容
                    label: { show: true },
                    // 放入原始資料供 Tooltip 使用
                    raw: item 
                });
            });

            return Object.values(categories);
        }

        // 獲取資料
        // 注意：請確保路徑與 GitHub 上的資料夾結構一致
        fetch('./data/STOCK_DAY_ALL/latest.json')
            .then(response => {
                if (!response.ok) throw new Error('找不到資料檔案');
                return response.json();
            })
            .then(data => {
                loadingEl.style.display = 'none';
                const chartData = formatData(data);

                const option = {
                    title: { text: '台股成交值分布圖 (顏色代表漲跌)', left: 'center', top: 10 },
                    tooltip: {
                        formatter: function (info) {
                            const d = info.data.raw;
                            if (!d) return info.name;
                            return `
                                <div style="font-weight:bold">${d.Name} (${d.Code})</div>
                                產業：${d.Industry}<br/>
                                成交值：${(d.TradeValue / 100000000).toFixed(2)} 億<br/>
                                成交價：${d.Close}<br/>
                                漲跌幅：<span style="color:${d.Change > 0 ? 'red' : 'green'}">${d.Change}%</span>
                            `;
                        }
                    },
                    series: [{
                        type: 'treemap',
                        data: chartData,
                        leafDepth: 1, // 點擊可下鑽一層
                        levels: [
                            { itemStyle: { borderColor: '#fff', borderWidth: 2, gapWidth: 2 } },
                            { itemStyle: { borderColor: '#eee', borderWidth: 1, gapWidth: 1 } }
                        ],
                        label: {
                            show: true,
                            formatter: '{b}'
                        }
                    }]
                };

                myChart.setOption(option);
            })
            .catch(err => {
                loadingEl.innerText = '讀取失敗: ' + err.message;
                console.error(err);
            });

        // 隨視窗大小縮放
        window.addEventListener('resize', myChart.resize);
    </script>
</body>
</html>
