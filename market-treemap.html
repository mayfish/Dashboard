<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>台股成交比重與型態分析看板</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background-color: #1a1a1a; color: white; overflow: hidden; font-family: "Microsoft JhengHei", sans-serif; }
        #header { height: 75px; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; background: #222; border-bottom: 1px solid #444; }
        .title-group { display: flex; flex-direction: column; }
        #date-display { font-size: 1.1rem; font-weight: bold; color: #ffca28; }
        #total-volume { font-size: 0.9rem; color: #00e5ff; margin-top: 2px; }
        .action-group { display: flex; align-items: center; gap: 10px; }
        #stock-search { padding: 8px 12px; background: #333; color: white; border: 1px solid #666; border-radius: 4px; outline: none; width: 150px; }
        #date-selector { padding: 8px 15px; background: #333; color: white; border: 1px solid #666; border-radius: 4px; cursor: pointer; }
        #main { width: 100vw; height: calc(100vh - 75px); }
        #k-line-modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90vw; height: 85vh; background: #1e1e1e; border: 1px solid #555; border-radius: 12px; z-index: 100; box-shadow: 0 10px 30px rgba(0,0,0,0.8); }
        #modal-header { padding: 15px 25px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        #k-line-chart { width: 100%; height: calc(85vh - 75px); }
        #close-btn { cursor: pointer; font-size: 28px; color: #888; }
        #overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 99; backdrop-filter: blur(3px); }
        #loading-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 18px; z-index: 10; background: rgba(0,0,0,0.8); padding: 20px; border-radius: 8px; border: 1px solid #444; display: none; }
    </style>
</head>
<body>
    <div id="header">
        <div class="title-group">
            <div id="date-display">讀取中...</div>
            <div id="total-volume">計算中...</div>
        </div>
        <div class="action-group">
            <input type="text" id="stock-search" placeholder="搜尋代號或名稱">
            <select id="date-selector"></select>
        </div>
    </div>
    <div id="loading-overlay">資料載入中...</div>
    <div id="main"></div>
    <div id="overlay"></div>
    <div id="k-line-modal">
        <div id="modal-header">
            <div id="modal-title" style="font-weight:bold; color:#ffca28;"></div>
            <div id="close-btn">&times;</div>
        </div>
        <div id="k-line-chart"></div>
    </div>

    <script>
        const myChart = echarts.init(document.getElementById('main'), 'dark');
        const kChart = echarts.init(document.getElementById('k-line-chart'), 'dark');
        const BASE_URL = './data/STOCK_DAY_ALL/';
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbxOQ5-B8JFmkTSZ1SwcUaEzikem-WtogD6adFdcMQSs7Iun_gJ39d5dOS455ovj0yHY/exec'; 

        let currentData = [];

        // 搜尋邏輯
        document.getElementById('stock-search').onkeypress = function(e) {
            if (e.key === 'Enter') {
                const k = this.value.trim().toLowerCase();
                const t = currentData.find(i => i.Code.toString().trim() === k || i.Name.includes(k));
                if (t) showKLine(t.Code, t.Name);
                else if (/^\d+$/.test(k)) showKLine(k, "歷史搜尋");
            }
        };

        function formatDisplayDate(s) {
            if (!s) return '';
            const c = s.toString().replace('.json', '');
            if (c.includes('-')) { const p = c.split('-'); return `${p[0]-1911}/${p[1]}/${p[2]}`; }
            if (c.length >= 7) return `${c.substring(0,3)}/${c.substring(3,5)}/${c.substring(5,7)}`;
            return c;
        }

        async function showKLine(c, n) {
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('k-line-modal').style.display = 'block';
            document.getElementById('modal-title').innerText = `${n} (${c}) 歷史 K 線`;
            kChart.showLoading();
            try {
                const res = await fetch(`${GAS_URL}?code=${c}`);
                const h = await res.json();
                kChart.hideLoading();
                kChart.setOption({
                    xAxis: { data: h.map(i => formatDisplayDate(i.date)) },
                    yAxis: { scale: true },
                    dataZoom: [{ type: 'inside', start: 50, end: 100 }, { type: 'slider' }],
                    series: [{ type: 'candlestick', data: h.map(i => [i.open, i.close, i.low, i.high]), itemStyle: { color: '#ef5350', color0: '#26a69a' } }]
                }, true);
            } catch (e) { kChart.showLoading({text: '讀取失敗'}); }
        }

        async function updateChart(file) {
            document.getElementById('loading-overlay').style.display = 'block';
            try {
                const res = await fetch(`${BASE_URL}${file}?v=${Date.now()}`);
                const raw = await res.json();
                currentData = raw;

                const totalVal = raw.reduce((a, b) => a + (parseFloat(b.TradeValue) || 0), 0);
                document.getElementById('total-volume').innerText = `市場總成交值：約 ${(totalVal / 100000000).toFixed(2)} 億元`;
                document.getElementById('date-display').innerText = `資料日期：${formatDisplayDate(raw[0].Date)}`;

                const chartData = raw.filter(i => parseFloat(i.TradeValue) > 0).map(i => {
                    const val = parseFloat(i.TradeValue);
                    const close = parseFloat(i.ClosingPrice);
                    const diff = parseFloat(i.Change) || 0;
                    const prevClose = close - diff;
                    // 正確計算漲跌幅百分比
                    const changePercent = prevClose !== 0 ? ((diff / prevClose) * 100).toFixed(2) : 0;
                    const ratio = ((val / totalVal) * 100).toFixed(2);

                    return {
                        name: `${i.Name}\n${ratio}%`,
                        value: val,
                        itemStyle: { color: diff > 0 ? '#ef5350' : (diff < 0 ? '#26a69a' : '#999') },
                        raw: { ...i, ratio, changePercent }
                    };
                });

                myChart.setOption({
                    tooltip: {
                        formatter: info => {
                            const d = info.data.raw;
                            const cColor = parseFloat(d.Change) > 0 ? '#ff4d4f' : (parseFloat(d.Change) < 0 ? '#52c41a' : '#ccc');
                            return `<b>${d.Name} (${d.Code})</b><br/>
                                    收盤價：${d.ClosingPrice}<br/>
                                    漲跌值：<span style="color:${cColor}">${d.Change} 元</span><br/>
                                    漲跌幅：<span style="color:${cColor}">${d.changePercent}%</span><br/>
                                    成交佔比：${d.ratio}%`;
                        }
                    },
                    series: [{ type: 'treemap', data: chartData, breadcrumb: { show: false }, label: { show: true, fontSize: 11 }, itemStyle: { borderColor: '#1a1a1a' } }]
                }, true);
                document.getElementById('loading-overlay').style.display = 'none';
            } catch (e) { console.error(e); }
        }

        async function init() {
            const res = await fetch(`${BASE_URL}filelist.json?v=${Date.now()}`);
            if (res.ok) {
                const files = await res.json();
                const sel = document.getElementById('date-selector');
                files.forEach(f => { const o = document.createElement('option'); o.value = f; o.text = formatDisplayDate(f); sel.appendChild(o); });
                updateChart(sel.value);
            }
        }

        myChart.on('click', p => p.data && p.data.raw && showKLine(p.data.raw.Code, p.data.raw.Name));
        document.getElementById('date-selector').onchange = (e) => updateChart(e.target.value);
        document.getElementById('close-btn').onclick = document.getElementById('overlay').onclick = () => {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('k-line-modal').style.display = 'none';
        };
        window.onresize = () => { myChart.resize(); kChart.resize(); };
        init();
    </script>
</body>
</html>
