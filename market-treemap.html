<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>台股市場成交值比重</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background-color: #1a1a1a; color: white; overflow: hidden; }
        #header { height: 60px; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #222; border-bottom: 1px solid #444; }
        #date-display { font-size: 1.2rem; font-weight: bold; color: #ffca28; }
        #main { width: 100vw; height: calc(100vh - 60px); }
        #loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 18px; }
    </style>
</head>
<body>
    <div id="header">
        <div>台股當日表現板塊圖</div>
        <div id="date-display">讀取中...</div>
    </div>
    <div id="loading">資料讀取中...</div>
    <div id="main"></div>

    <script>
        const chartDom = document.getElementById('main');
        const myChart = echarts.init(chartDom, 'dark');
        const dateDisplay = document.getElementById('date-display');
        const loadingEl = document.getElementById('loading');

        // 格式化日期：將 1141125 轉為 114/11/25
        function formatDate(dateStr) {
            if (!dateStr || dateStr.length < 7) return dateStr;
            return `${dateStr.substring(0, 3)}/${dateStr.substring(3, 5)}/${dateStr.substring(5, 7)}`;
        }

        // 直接載入並顯示資料
        fetch('./data/STOCK_DAY_ALL/latest.json')
            .then(res => res.json())
            .then(rawData => {
                loadingEl.style.display = 'none';
                
                // 1. 顯示日期 (取第一筆資料的 Date 欄位)
                if (rawData.length > 0) {
                    dateDisplay.innerText = `資料日期：${formatDate(rawData[0].Date)}`;
                }

                // 2. 轉換資料：直接將所有股票作為第一層節點
                const chartData = rawData
                    .filter(item => parseFloat(item.TradeValue) > 0) // 過濾掉無成交量的
                    .map(item => {
                        const change = parseFloat(item.Change);
                        // 判斷顏色：漲(紅)、跌(綠)、平(灰)
                        let color = '#999';
                        if (change > 0) color = '#ef5350';
                        else if (change < 0) color = '#26a69a';

                        return {
                            name: `${item.Name}\n${item.ClosingPrice}`,
                            value: parseFloat(item.TradeValue),
                            itemStyle: { color: color },
                            // 儲存原始資料供 Tooltip 使用
                            raw: item
                        };
                    });

                const option = {
                    backgroundColor: '#1a1a1a',
                    tooltip: {
                        formatter: function (info) {
                            const d = info.data.raw;
                            return `
                                <div style="font-weight:bold; border-bottom:1px solid #fff; margin-bottom:5px;">${d.Name} (${d.Code})</div>
                                成交價：${d.ClosingPrice}<br/>
                                漲跌額：${d.Change}<br/>
                                成交金額：${(parseFloat(d.TradeValue) / 100000000).toFixed(2)} 億
                            `;
                        }
                    },
                    series: [{
                        type: 'treemap',
                        data: chartData,
                        roam: false, // 禁用縮放平移，直接看全貌
                        nodeClick: false, // 禁用點擊下鑽
                        breadcrumb: { show: false }, // 隱藏底部路徑
                        label: {
                            show: true,
                            position: 'inside',
                            formatter: '{b}',
                            fontSize: 12
                        },
                        itemStyle: {
                            borderColor: '#1a1a1a',
                            borderWidth: 1,
                            gapWidth: 1
                        },
                        levels: [
                            { itemStyle: { gapWidth: 1 } }
                        ]
                    }]
                };

                myChart.setOption(option);
            })
            .catch(err => {
                loadingEl.innerText = '讀取失敗，請檢查資料路徑。';
                console.error(err);
            });

        window.addEventListener('resize', myChart.resize);
    </script>
</body>
</html>
